<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Bodega</title>
    <!-- Carga de Tailwind CSS para un diseño moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        /* Clase para animar la actualización de la tarjeta */
        .card-update-pulse {
            animation: pulse-ring 0.6s ease-out;
        }
        @keyframes pulse-ring {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(44, 123, 229, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(44, 123, 229, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(44, 123, 229, 0); }
        }
        .tab-button {
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px; /* Para que parezca unirse al borde inferior */
        }
        .tab-button.active {
            background-color: #ffffff;
            color: #2c7be5;
            border-color: #e2e8f0;
            border-bottom-color: #ffffff;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }
        /* Estilo para hacer que la tabla sea responsiva en móviles */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
        .input-inline {
            width: 100%;
            padding: 4px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app-container" style="display: none;">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Sistema de Gestión de Bodega</h1>

            <!-- DASHBOARD DE TARJETAS (Ganancia Mínima) -->
            <div id="dashboard" class="mb-8">
                <!-- La tarjeta principal se renderiza aquí -->
            </div>

            <!-- CONTROL DE PESTAÑAS -->
            <div class="flex border-b border-gray-200 mb-6 -mx-4 sm:mx-0">
                <button id="tab-registro" class="tab-button active px-4 py-2 text-sm font-medium rounded-t-lg transition-colors bg-white text-blue-600 shadow-sm ml-4 sm:ml-0" onclick="switchTab('registro')">
                    Registro de Ventas Diarias
                </button>
                <button id="tab-inventario" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 rounded-t-lg hover:bg-gray-100 transition-colors" onclick="switchTab('inventario')">
                    Gestión de Inventario
                </button>
            </div>

            <!-- CONTENIDO DE LAS PESTAÑAS -->
            <div id="content-registro" class="bg-white p-4 sm:p-6 rounded-xl card-shadow min-h-[500px]">
                <!-- Contenido de Registro de Ventas -->
            </div>

            <div id="content-inventario" class="bg-white p-4 sm:p-6 rounded-xl card-shadow min-h-[500px] hidden">
                <!-- Contenido de Gestión de Inventario -->
            </div>
        </div>
    </div>

    <script>
        // Carga de la librería de iconos Lucide
        const lucideScript = document.createElement('script');
        lucideScript.src = "https://unpkg.com/lucide@latest";
        document.head.appendChild(lucideScript);

        // --- CONFIGURACIÓN DE LA API ---
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx07_ofDPNTdeF1QpoMpqrMBfG9L7DzeNVMrZCdXC4PTzHff_JVP7USs6AlsDaU7Cm-/exec';

        // --- ESTADO GLOBAL ---
        let productos = [];
        let ventasDiarias = []; // Contiene las ventas del día seleccionado
        
        // Corrección: Obtener la fecha local en formato YYYY-MM-DD para evitar errores de zona horaria
        const hoy = new Date();
        const anio = hoy.getFullYear();
        const mes = String(hoy.getMonth() + 1).padStart(2, '0'); // getMonth() es 0-indexado
        const dia = String(hoy.getDate()).padStart(2, '0');
        let selectedDate = `${anio}-${mes}-${dia}`; // Fecha seleccionada en el visor

        const GANANCIA_MINIMA = 60.00;
        let nextProductId = 1;

        function safeCreateIcons() {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function parseFractionToFloat(inputString) {
            if (!inputString) return NaN;
            const cleanedInput = String(inputString).trim().replace(',', '.');
            const fractionMatch = cleanedInput.match(/^(\d+)\/(\d+)$/);
            if (fractionMatch) {
                const numerator = parseInt(fractionMatch[1], 10);
                const denominator = parseInt(fractionMatch[2], 10);
                if (denominator !== 0) return numerator / denominator;
            }
            const decimalValue = parseFloat(cleanedInput);
            return !isNaN(decimalValue) ? decimalValue : NaN;
        }

        function getUnitFromProductName(name) {
            name = name.toLowerCase();
            if (name.includes('kg') || name.includes(' lenteja') || name.includes('harina') || name.includes('azúcar') || name.includes('arroz')) return 'kg';
            if (name.includes('1l') || name.includes('litro') || name.includes('aceite')) return 'L';
            return 'unid';
        }

        // --- SINCRONIZACIÓN CON GOOGLE SHEETS ---

        async function fetchSalesForDate(dateString) {
            const sheetName = dateString;
            const url = `${APPS_SCRIPT_URL}?action=getSales&sheetName=${sheetName}&t=${new Date().getTime()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.statusText} (Código: ${response.status})`);
                }
                const data = await response.json();

                if (data.error) {
                    throw new Error(`Error del script: ${data.error}`);
                }

                if (!Array.isArray(data)) {
                    console.error("La respuesta no es un array:", data);
                    throw new Error("La respuesta del servidor no es un array de ventas válido.");
                }

                return data.map(venta => {
                    const cleanVenta = {};
                    for (const key in venta) {
                        cleanVenta[key.trim()] = venta[key];
                    }
                    return {
                        ...cleanVenta,
                        'Cantidad': parseFractionToFloat(cleanVenta['Cantidad']),
                        'Costo Unitario (S/)': parseFloat(cleanVenta['Costo Unitario (S/)'] || 0),
                        'PVP Unitario (S/)': parseFloat(cleanVenta['PVP Unitario (S/)'] || 0),
                        'Precio Total (S/)': parseFloat(cleanVenta['Precio Total (S/)'] || 0),
                        'Ganancia (S/)': parseFloat(cleanVenta['Ganancia (S/)'] || 0)
                    };
                });
            } catch (error) {
                console.error(`Error al cargar las ventas para ${dateString}:`, error);
                alertMessage(`No se pudieron cargar las ventas para ${dateString}.`, 'red');
                return []; // Devuelve un array vacío en caso de error
            }
        }

        async function syncInventoryWithSheet() {
            const inventoryPayload = productos.map(p => {
                const costo = p['Costo (S/)'];
                const pvpReal = p['PVP Real (S/)'];
                const pvpSugerido = (costo * 1.20);
                const margenActual = pvpReal - costo;
                return {
                    'Producto': p['Producto'],
                    'Costo (S/)': costo,
                    'PVP Sugerido (S/)': pvpSugerido,
                    'PVP Real (S/)': pvpReal,
                    'Margen Actual (S/)': margenActual,
                    'Unidad': p['Unidad']
                };
            });

            try {
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'syncInventory', payload: inventoryPayload })
                });
                console.log('Sincronización de inventario iniciada.');
                alertMessage('Inventario sincronizado con la nube.', 'blue');
            } catch (error) {
                console.error('Error al sincronizar el inventario:', error);
                alertMessage('Error al sincronizar inventario.', 'red');
            }
        }

        async function addSaleToSheet(saleData) {
            const hoy = new Date();
            const anio = hoy.getFullYear();
            const mes = String(hoy.getMonth() + 1).padStart(2, '0');
            const dia = String(hoy.getDate()).padStart(2, '0');
            const sheetName = `${anio}-${mes}-${dia}`; // Siempre registra en la hoja de hoy (local)
            try {
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'addSale', sheetName: sheetName, payload: saleData })
                });
                console.log('Sincronización de venta iniciada.');
            } catch (error) {
                console.error('Error al añadir venta a la hoja:', error);
                alertMessage('Error al guardar venta en la nube.', 'red');
            }
        }

        // --- DATOS INICIALES Y LÓGICA DE LA APP ---
        function initializeProducts() {
            const initialData = [
                { nombre: "Aceite vegetal Deleite 1L", costo: 7.50 },
                { nombre: "Aceite vegetal Patrona 1L", costo: 8.00 },
                { nombre: "Aceite vegetal Primor 1L", costo: 9.20 },
                { nombre: "Arroz 1 kg", costo: 4.00 },
                { nombre: "Avena clásica 3 ositos (bolsa)", costo: 4.80 },
                { nombre: "Avena en Hojuelas Quaker (caja)", costo: 6.50 },
                { nombre: "Avena quinua 3 ositos (bolsa)", costo: 5.20 },
                { nombre: "Azúcar 1kg", costo: 4.30 },
                { nombre: "Bebida (Brut/Cava) Marca no clara", costo: 15.00 },
                { nombre: "Bolsas de Granos Florida (varios)", costo: 3.50 },
                { nombre: "Caldos Maggi (cubo x 6)", costo: 2.80 },
                { nombre: "Canela (bolsa pequeña)", costo: 1.50 },
                { nombre: "Chocolate de taza (tableta)", costo: 5.50 },
                { nombre: "Chocolate en Barra Sublime (unid)", costo: 1.80 },
                { nombre: "Cocoa winter's (lata)", costo: 7.00 },
                { nombre: "Conserva Florida (atún)", costo: 3.80 },
                { nombre: "Conserva Gloria (atún)", costo: 3.50 },
                { nombre: "Detergente en Polvo Noble 1kg", costo: 7.50 },
                { nombre: "Esencia de Vainilla Katita Vainilla", costo: 3.00 },
                { nombre: "Fideos sopa Anita 250g", costo: 1.50 },
                { nombre: "Fideos tallarin Anita 500g", costo: 2.40 },
                { nombre: "Filtrante Anis Herbi (caja 25u)", costo: 4.50 },
                { nombre: "Filtrante manzanilla McColin's", costo: 4.80 },
                { nombre: "Filtrante Te bolsita (caja 25u)", costo: 3.50 },
                { nombre: "Fosforo (caja)", costo: 0.80 },
                { nombre: "Granos/Legumbres Compass 500g", costo: 4.00 },
                { nombre: "Harina 1kg", costo: 3.20 },
                { nombre: "Harina de Trigo Medalla 1kg", costo: 3.50 },
                { nombre: "Harina Preparada/Maicena Maizena Duryea", costo: 5.50 },
                { nombre: "Hongos laurel (bolsa pequeña)", costo: 1.00 },
                { nombre: "Leche condensada (lata)", costo: 4.80 },
                { nombre: "Leche Bonlé (lata)", costo: 2.90 },
                { nombre: "Leche Bonlé (caja 1L)", costo: 3.80 },
                { nombre: "Leche en bolsa 1L", costo: 3.20 },
                { nombre: "Leche Gloria (caja 1L)", costo: 4.20 },
                { nombre: "Leche Gloria (chica lata)", costo: 3.00 },
                { nombre: "Leche Gloria (grande lata)", costo: 3.90 },
                { nombre: "Leche Gloria (niños caja)", costo: 4.50 },
                { nombre: "Leche Gloria zero lactosa (lata)", costo: 3.50 },
                { nombre: "Leche Gloria zero lactosa (caja)", costo: 4.80 },
                { nombre: "Leche Laive (lata)", costo: 3.10 },
                { nombre: "Leche Laive sin lactosa (caja)", costo: 4.90 },
                { nombre: "Leche Pura vida (chica lata)", costo: 2.80 },
                { nombre: "Leche Pura vida (grande lata)", costo: 3.70 },
                { nombre: "Lenteja 1 kg", costo: 6.00 },
                { nombre: "Maizena Duryea", costo: 5.50 },
                { nombre: "Mani (bolsa pequeña)", costo: 1.50 },
                { nombre: "Mayonesa Alacena (sachet)", costo: 2.00 },
                { nombre: "Mezcla Láctea Pura Vida (caja)", costo: 3.50 },
                { nombre: "Papel Higiénico Jade (rollo)", costo: 1.20 },
                { nombre: "Papel Higiénico Noble 2 rollos", costo: 3.00 },
                { nombre: "Papel Higiénico Paracas 4 rollos", costo: 6.00 },
                { nombre: "Papel Higiénico Tull 6 rollos", costo: 8.50 },
                { nombre: "Papel servilleta Sublime", costo: 0.50 },
                { nombre: "Papel Toalla Nova (rollo)", costo: 5.00 },
                { nombre: "Papel Toalla Paracas (rollo)", costo: 4.00 },
                { nombre: "Pimienta comino (bolsa pequeña)", costo: 1.00 },
                { nombre: "Sala de tomate Don Vittorio", costo: 2.50 },
                { nombre: "Sillao Ajinomoto (botella)", costo: 4.00 },
                { nombre: "Sillao Kikí (botella)", costo: 3.80 },
                { nombre: "Sopas/Condimentos McCrispy's (o similar)", costo: 1.50 },
                { nombre: "Sopas/Condimentos Sibarita (o similar)", costo: 1.20 },
                { nombre: "Vainilla Katita", costo: 3.00 },
            ];
            productos = initialData.map((p, i) => ({
                id: i + 1,
                'Producto': p.nombre,
                'Costo (S/)': p.costo,
                'PVP Real (S/)': parseFloat((p.costo * 1.20).toFixed(2)),
                'Unidad': getUnitFromProductName(p.nombre)
            }));
            nextProductId = productos.length + 1;
            syncInventoryWithSheet();
        }

        // --- INICIALIZACIÓN Y CONTROL DE ACCESO ---
        document.addEventListener('DOMContentLoaded', async () => {
            const appContainer = document.getElementById('app-container');
            // Contraseña eliminada: la aplicación ahora es de acceso público.
            appContainer.style.display = 'block';
            initializeProducts();
            ventasDiarias = await fetchSalesForDate(selectedDate);
            renderizarTodo();
            lucideScript.onload = safeCreateIcons;
        });

        async function handleDateChange(event) {
            selectedDate = event.target.value;
            ventasDiarias = await fetchSalesForDate(selectedDate);
            renderizarTodo();
        }

        function switchTab(tabName) {
            ['registro', 'inventario'].forEach(tab => {
                document.getElementById(`content-${tab}`).classList.add('hidden');
                document.getElementById(`tab-${tab}`).classList.remove('active', 'bg-white', 'text-blue-600', 'shadow-sm');
                document.getElementById(`tab-${tab}`).classList.add('text-gray-500', 'hover:bg-gray-100');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active', 'bg-white', 'text-blue-600', 'shadow-sm');
            renderizarTodo();
            safeCreateIcons();
        }

        function calcularTotales() {
            const totalVenta = ventasDiarias.reduce((sum, venta) => sum + (venta['Precio Total (S/)'] || 0), 0);
            const totalGanancia = ventasDiarias.reduce((sum, venta) => sum + (venta['Ganancia (S/)'] || 0), 0);
            return { totalVenta, totalGanancia };
        }

        function renderizarTodo() {
            const currentTabElement = document.querySelector('.tab-button.active');
            const currentTab = currentTabElement ? currentTabElement.id.split('-')[1] : 'registro';
            const totales = calcularTotales();
            renderDashboard(totales.totalVenta, totales.totalGanancia);
            if (currentTab === 'registro') renderRegistroVentas();
            if (currentTab === 'inventario') renderGestionInventario();
            safeCreateIcons();
        }

        function renderDashboard(ventaReal, gananciaNeta) {
            const dashboardContainer = document.getElementById('dashboard');
            const diferencia = gananciaNeta - GANANCIA_MINIMA;
            const cumplioMeta = gananciaNeta >= GANANCIA_MINIMA;
            const colorFondo = cumplioMeta ? 'bg-blue-600' : 'bg-red-500';
            const icono = cumplioMeta ? 'trending-up' : 'trending-down';
            const mensajeStatus = cumplioMeta ? '¡Felicidades! Meta de Ganancia Mínima cumplida.' : 'ALERTA: Ganancia Mínima no alcanzada.';
            const diferenciaTexto = cumplioMeta ? `¡Sobrante de S/ ${diferencia.toFixed(2)}!` : `Faltan S/ ${Math.abs(diferencia).toFixed(2)} para los ${GANANCIA_MINIMA.toFixed(2)}.`;

            const tarjetaHTML = `
                <div id="main-card" class="${colorFondo} text-white p-6 rounded-xl card-shadow transition-all duration-300 card-update-pulse">
                    <div class="flex items-start justify-between">
                        <h2 class="text-lg font-semibold opacity-80 mb-1">VENTA REAL ACUMULADA</h2>
                        <i data-lucide="${icono}" class="w-6 h-6"></i>
                    </div>
                    <p class="text-5xl font-extrabold mb-4">S/ ${ventaReal.toFixed(2)}</p>
                    <div class="space-y-2 text-sm pt-4 border-t border-white border-opacity-30">
                        <div class="flex justify-between"><span class="opacity-70">Meta Ganancia Mínima:</span><span class="font-bold">S/ ${GANANCIA_MINIMA.toFixed(2)}</span></div>
                        <div class="flex justify-between text-lg font-bold"><span>GANANCIA NETA REAL:</span><span>${gananciaNeta.toFixed(2)}</span></div>
                        <div class="flex justify-between font-semibold pt-2"><span>Estado de la Meta:</span><span class="font-extrabold ${cumplioMeta ? 'text-green-200' : 'text-red-200'}">${diferenciaTexto}</span></div>
                    </div>
                </div>
                <div class="text-center mt-4 p-3 rounded-lg bg-white border border-gray-200 text-gray-700 font-semibold card-shadow">${mensajeStatus}</div>
            `;
            dashboardContainer.innerHTML = tarjetaHTML;
            safeCreateIcons();
            const mainCard = document.getElementById('main-card');
            mainCard.classList.remove('card-update-pulse');
            void mainCard.offsetWidth;
            mainCard.classList.add('card-update-pulse');
        }

        function updateQuantityLabel() {
            const select = document.getElementById('regSelectProducto');
            const label = document.getElementById('regCantidadLabel');
            if (!select || !label) return;
            const selectedOption = select.options[select.selectedIndex];
            let unitText = 'Unidades';
            if (selectedOption && selectedOption.value) {
                const producto = productos.find(p => p.id === parseInt(selectedOption.value));
                if (producto) {
                    if (producto['Unidad'] === 'kg') unitText = 'Kilogramos (Ej: 0.5 o 1/2)';
                    else if (producto['Unidad'] === 'L') unitText = 'Litros (Ej: 0.25 o 1/4)';
                }
            }
            label.textContent = `Cantidad (${unitText})`;
        }

        function renderRegistroVentas() {
            const container = document.getElementById('content-registro');
            if (container.classList.contains('hidden')) return;

            const hoy = new Date();
            const anio = hoy.getFullYear();
            const mes = String(hoy.getMonth() + 1).padStart(2, '0');
            const dia = String(hoy.getDate()).padStart(2, '0');
            const today = `${anio}-${mes}-${dia}`;
            const isToday = selectedDate === today;

            const displayDateObj = new Date(selectedDate + 'T12:00:00Z');
            const displayDate = displayDateObj.toLocaleDateString('es-PE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const formHTML = `
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Registrar Nueva Venta</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="col-span-2 md:col-span-1">
                        <label for="regSelectProducto" class="block text-sm font-medium text-gray-600">Producto</label>
                        <select id="regSelectProducto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" onchange="updateSalePrice(); updateQuantityLabel();">
                            <option value="" disabled selected>-- Elija un producto --</option>
                            ${productos.map(p => `<option value="${p.id}">${p['Producto']}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="regCantidadVendida" class="block text-sm font-medium text-gray-600" id="regCantidadLabel">Cantidad</label>
                        <input type="text" id="regCantidadVendida" placeholder="Ej: 0.5 o 1/2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" value="1" oninput="updateSalePrice()">
                    </div>
                    <div>
                        <label for="regPrecioVenta" class="block text-sm font-medium text-gray-600">Precio Total (S/)</label>
                        <input type="number" id="regPrecioVenta" placeholder="Total" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border font-bold" min="0" step="0.01">
                        <p id="precio-unitario-hint" class="text-xs text-gray-500 mt-1">PVP unitario sugerido: S/ 0.00</p>
                    </div>
                    <div>
                        <label for="regMetodoPago" class="block text-sm font-medium text-gray-600">Método de Pago</label>
                        <select id="regMetodoPago" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Yape">Yape</option>
                        </select>
                    </div>
                </div>
                <button onclick="registrarVenta()" class="w-full md:w-auto px-6 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors">Confirmar Venta</button>
                <p id="msg-venta" class="mt-3 text-sm text-center text-gray-500"></p>
            `;

            container.innerHTML = `
                <div class="flex flex-wrap justify-between items-center mb-4 pb-4 border-b">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-2 md:mb-0">Visor de Ventas</h2>
                    <div class="flex items-center">
                        <label for="sales-date-picker" class="text-sm font-medium text-gray-600 mr-2">Mostrando ventas de:</label>
                        <input type="date" id="sales-date-picker" value="${selectedDate}" max="${today}" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                ${isToday ? formHTML : '<div class="text-center p-4 bg-gray-100 rounded-lg text-gray-600">Solo se pueden registrar nuevas ventas para el día de hoy. Seleccione la fecha actual para registrar ventas.</div>'}

                <h3 class="text-xl font-semibold mt-8 mb-4 border-t pt-4">Ventas Registradas de ${displayDate}</h3>
                <div id="ventas-list" class="space-y-3"></div>
            `;
            
            document.getElementById('sales-date-picker').addEventListener('change', handleDateChange);
            
            if (isToday) {
                updateSalePrice();
                updateQuantityLabel();
            }
            renderVentasList();
        }

        function updateSalePrice() {
            const select = document.getElementById('regSelectProducto');
            const cantidadInput = document.getElementById('regCantidadVendida');
            const precioTotalInput = document.getElementById('regPrecioVenta');
            const hint = document.getElementById('precio-unitario-hint');
            if (!select || !cantidadInput || !precioTotalInput || !hint) return;
            const selectedOption = select.options[select.selectedIndex];
            let pvpUnitario = 0;
            if (selectedOption && selectedOption.value) {
                const producto = productos.find(p => p.id === parseInt(selectedOption.value));
                if (producto) pvpUnitario = producto['PVP Real (S/)'];
            }
            hint.textContent = `PVP unitario sugerido: S/ ${pvpUnitario.toFixed(2)} por unidad/kg/L`;
            const cantidadDecimal = parseFractionToFloat(cantidadInput.value);
            if (isNaN(cantidadDecimal) || cantidadDecimal <= 0) {
                precioTotalInput.value = '';
                if (cantidadInput.value) {
                    hint.textContent = 'Error en Cantidad. Use 1, 0.5, 1/2, etc.';
                    precioTotalInput.classList.add('border-red-500');
                }
                return;
            }
            precioTotalInput.classList.remove('border-red-500');
            precioTotalInput.value = (pvpUnitario * cantidadDecimal).toFixed(2);
        }

        function registrarVenta() {
            const select = document.getElementById('regSelectProducto');
            const cantidadInput = document.getElementById('regCantidadVendida');
            const precioTotalInput = document.getElementById('regPrecioVenta');
            const pagoInput = document.getElementById('regMetodoPago');
            const msg = document.getElementById('msg-venta');
            const productoId = parseInt(select.value);
            const cantidadDecimal = parseFractionToFloat(cantidadInput.value);
            const precioTotal = parseFloat(precioTotalInput.value);
            const metodoPago = pagoInput.value;
            const productoVendido = productos.find(p => p.id === productoId);

            if (!productoVendido || isNaN(cantidadDecimal) || cantidadDecimal <= 0 || isNaN(precioTotal) || precioTotal <= 0) {
                msg.textContent = 'Error: Complete todos los campos correctamente.';
                msg.className = 'mt-3 text-sm text-center text-red-500 font-semibold';
                return;
            }

            const costoUnitario = productoVendido['Costo (S/)'];
            const precioVentaUnitario = precioTotal / cantidadDecimal;
            const gananciaVenta = (precioVentaUnitario - costoUnitario) * cantidadDecimal;

            const nuevaVenta = {
                'Fecha y Hora': new Date().toISOString(),
                'Producto': productoVendido['Producto'],
                'Cantidad': cantidadDecimal,
                'Unidad': productoVendido['Unidad'],
                'Costo Unitario (S/)': costoUnitario,
                'PVP Unitario (S/)': precioVentaUnitario,
                'Precio Total (S/)': precioTotal,
                'Método de Pago': metodoPago,
                'Ganancia (S/)': gananciaVenta
            };

            ventasDiarias.push(nuevaVenta);
            addSaleToSheet(nuevaVenta);

            msg.textContent = `Venta registrada. Ganancia: S/ ${gananciaVenta.toFixed(2)} (${metodoPago}).`;
            msg.className = 'mt-3 text-sm text-center text-green-500 font-semibold';
            
            select.value = '';
            cantidadInput.value = '1';
            precioTotalInput.value = '';
            updateQuantityLabel();
            renderizarTodo();
        }

        function renderVentasList() {
            const listContainer = document.getElementById('ventas-list');
            if (!listContainer) return;
            if (ventasDiarias.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-sm">No hay ventas registradas para la fecha seleccionada.</p>';
                return;
            }
            listContainer.innerHTML = ventasDiarias.slice().reverse().map((venta) => {
                const pagoColor = venta['Método de Pago'] === 'Yape' ? 'bg-indigo-100 text-indigo-800' : 'bg-green-100 text-green-800';
                const displayCantidad = parseFloat(venta['Cantidad']).toFixed(2).replace(/\.00$/, '');
                const time = new Date(venta['Fecha y Hora']).toLocaleTimeString('es-PE');
                return `
                    <div class="flex flex-wrap md:flex-row justify-between items-center p-3 bg-gray-50 border border-gray-200 rounded-lg">
                        <div class="font-medium text-gray-800 w-full md:w-1/2 mb-2 md:mb-0">
                            ${displayCantidad}x ${venta['Producto']}
                            <span class="text-xs text-gray-500 ml-2">(${time})</span>
                        </div>
                        <div class="text-right flex flex-col sm:flex-row space-x-0 sm:space-x-4 w-full md:w-1/2 items-end md:items-center justify-end">
                            <span class="text-xs font-medium ${pagoColor} px-2 py-0.5 rounded-full mb-1 sm:mb-0">${venta['Método de Pago']}</span>
                            <p class="text-sm font-semibold">Total: S/ ${venta['Precio Total (S/)'].toFixed(2)}</p>
                            <p class="text-sm text-green-600 font-bold ml-0 sm:ml-4">G: S/ ${venta['Ganancia (S/)'].toFixed(2)}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderGestionInventario() {
            const container = document.getElementById('content-inventario');
            if (container.classList.contains('hidden')) return;
            container.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Lista y Edición de Productos</h2>
                <p class="text-sm text-gray-500 mb-6">Los cambios se guardan en la nube automáticamente al hacer clic en "Guardar".</p>
                <button onclick="addProduct()" class="mb-4 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition-colors shadow flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Añadir Nuevo Producto
                </button>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Producto</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Costo (S/)</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">PVP Sugerido (S/)</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">PVP Real (S/)</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Margen Actual (S/)</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            `;
            renderInventoryTable();
            safeCreateIcons();
        }

        function renderInventoryTable() {
            const tbody = document.getElementById('inventory-table-body');
            if (!tbody) return;
            tbody.innerHTML = productos.map(p => {
                const costo = p['Costo (S/)'];
                const pvpReal = p['PVP Real (S/)'];
                const margenActual = pvpReal - costo;
                const pvpSugerido = (costo * 1.20).toFixed(2);
                const margenColor = margenActual > 0 ? 'text-green-600' : (margenActual < 0 ? 'text-red-500' : 'text-gray-500');
                return `
                    <tr id="row-${p.id}" class="hover:bg-gray-50 transition-colors">
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900"><input type="text" id="name-${p.id}" value="${p['Producto']}" class="input-inline" /></td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500"><input type="number" id="cost-${p.id}" value="${costo.toFixed(2)}" class="input-inline w-20" step="0.01" min="0"></td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${pvpSugerido}</td>
                        <td class="px-3 py-2 whitespace-nowrap"><input type="number" id="pvp-${p.id}" value="${pvpReal.toFixed(2)}" class="input-inline w-20" step="0.01" min="0"></td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-bold ${margenColor}">S/ ${margenActual.toFixed(2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm space-x-2">
                            <button onclick="saveProductChanges(${p.id})" class="px-2 py-1 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors text-xs shadow">Guardar</button>
                            <button onclick="confirmDelete(${p.id}, '${p['Producto']}')" class="px-2 py-1 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors text-xs shadow">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function saveProductChanges(productId) {
            const nameInput = document.getElementById(`name-${productId}`);
            const costInput = document.getElementById(`cost-${productId}`);
            const pvpInput = document.getElementById(`pvp-${productId}`);
            const newName = nameInput.value.trim();
            const newCost = parseFloat(costInput.value);
            const newPVP = parseFloat(pvpInput.value);

            if (!newName) { alertMessage('El nombre del producto no puede estar vacío.', 'red'); return; }
            if (isNaN(newCost) || newCost < 0) { alertMessage('El Costo debe ser un número positivo.', 'red'); return; }
            if (isNaN(newPVP) || newPVP < 0) { alertMessage('El PVP Real debe ser un número positivo.', 'red'); return; }

            const productIndex = productos.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                productos[productIndex]['Producto'] = newName;
                productos[productIndex]['Costo (S/)'] = newCost;
                productos[productIndex]['PVP Real (S/)'] = newPVP;
                productos[productIndex]['Unidad'] = getUnitFromProductName(newName);
                renderizarTodo();
                syncInventoryWithSheet();
            }
        }

        function confirmDelete(productId, productName) {
            if (confirm(`¿Estás seguro de que quieres eliminar "${productName}"?`)) {
                productos = productos.filter(p => p.id !== productId);
                renderizarTodo();
                syncInventoryWithSheet();
            }
        }

        function addProduct() {
            const newProduct = {
                id: nextProductId++,
                'Producto': "Nuevo Producto (kg, L o unid)",
                'Costo (S/)': 1.00,
                'PVP Real (S/)': 1.20,
                'Unidad': 'unid'
            };
            productos.push(newProduct);
            renderizarTodo();
            syncInventoryWithSheet();
            setTimeout(() => {
                const newRow = document.getElementById(`row-${newProduct.id}`);
                if (newRow) {
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    document.getElementById(`name-${newProduct.id}`).focus();
                }
            }, 50);
        }

        function alertMessage(message, color) {
            let msgBox = document.getElementById('inventory-msg');
            if (!msgBox) {
                msgBox = document.createElement('div');
                msgBox.id = 'inventory-msg';
                document.body.appendChild(msgBox);
            }
            const bgColor = { green: 'bg-green-500', red: 'bg-red-500', blue: 'bg-blue-500' }[color] || 'bg-gray-700';
            msgBox.className = `fixed top-4 right-4 z-50 p-3 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300 ${bgColor}`;
            msgBox.textContent = message;
            msgBox.style.opacity = '1';
            setTimeout(() => { msgBox.style.opacity = '0'; }, 3000);
        }
    </script>
</body>
</html>
